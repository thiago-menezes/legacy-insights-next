name: Deploy Frontend

on:
  push:
    branches: ['main']
    paths:
      - '**'
      - '.github/workflows/deploy-frontend.yml'

env:
  PROJECT_ID: perfect-embassy-485121-b8
  GCE_INSTANCE: instance-20260202-003037
  GCE_ZONE: us-central1-c
  IMAGE_NAME: legacy-insights-next

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prd
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Docker Image
        run: |
          docker build \
            --build-arg STRAPI_URL="${{ vars.STRAPI_URL }}" \
            -t us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/legacy-insights/${{ env.IMAGE_NAME }}:latest .
          docker push us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/legacy-insights/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to VM
        run: |
          # Copy docker-compose.prod.yml to the VM
          gcloud compute scp docker-compose.prod.yml ${{ env.GCE_INSTANCE }}:~/docker-compose.prod.yml --zone=${{ env.GCE_ZONE }}

          gcloud compute ssh ${{ env.GCE_INSTANCE }} --zone=${{ env.GCE_ZONE }} --command="
            # Install Docker and Docker Compose if not found
            if ! command -v docker &> /dev/null; then
              echo 'Docker not found. Installing...'
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker \$USER
              # Restarting docker service to ensure it is running
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            # Authenticate Docker to Artifact Registry on the VM
            sudo gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

            # Deployment using Docker Compose
            export PROJECT_ID=${{ env.PROJECT_ID }}
            export STRAPI_URL=${{ vars.STRAPI_URL }}
            
            # Pull image with explicit env vars for the registry path
            sudo PROJECT_ID=$PROJECT_ID docker pull us-central1-docker.pkg.dev/$PROJECT_ID/legacy-insights/${{ env.IMAGE_NAME }}:latest
            
            # Run docker compose with explicit env vars
            sudo PROJECT_ID=$PROJECT_ID STRAPI_URL=$STRAPI_URL \
              docker compose -f ~/docker-compose.prod.yml up -d --force-recreate legacy-insights-next
          "
