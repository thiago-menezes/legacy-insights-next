name: Deploy Frontend

on:
  push:
    branches: ['main']
    paths:
      - '**'
      - '.github/workflows/deploy-frontend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prd
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
          service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ vars.GCP_REGISTRY }}

      - name: Build and Push Docker Image
        run: |
          docker build \
            --build-arg STRAPI_URL="${{ vars.STRAPI_URL }}" \
            --build-arg NEXT_PUBLIC_STRAPI_URL="${{ vars.STRAPI_URL }}" \
            -t ${{ vars.GCP_REGISTRY }}/${{ vars.PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/${{ vars.IMAGE_NAME }}:latest .
          docker push ${{ vars.GCP_REGISTRY }}/${{ vars.PROJECT_ID }}/${{ vars.ARTIFACT_REPO }}/${{ vars.IMAGE_NAME }}:latest

      - name: Deploy to VM
        run: |
          # Copy docker-compose.yml to the VM
          gcloud compute scp docker-compose.yml ${{ vars.GCE_INSTANCE }}:~/docker-compose.yml --zone=${{ vars.GCE_ZONE }}

          gcloud compute ssh ${{ vars.GCE_INSTANCE }} --zone=${{ vars.GCE_ZONE }} --command="
            # Install Docker and Docker Compose if not found
            if ! command -v docker &> /dev/null; then
              echo 'Docker not found. Installing...'
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker \$USER
              # Restarting docker service to ensure it is running
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            # Authenticate Docker to Artifact Registry on the VM
            sudo gcloud auth configure-docker ${{ vars.GCP_REGISTRY }} --quiet

            # Deployment using Docker Compose
            export GCP_REGISTRY=${{ vars.GCP_REGISTRY }}
            export REPO_NAME=${{ vars.ARTIFACT_REPO }}
            export IMAGE_NAME=${{ vars.IMAGE_NAME }}
            export PROJECT_ID=${{ vars.PROJECT_ID }}
            export STRAPI_URL=${{ vars.STRAPI_URL }}
            export AUTH_SECRET='${{ secrets.AUTH_SECRET }}'
            export STRAPI_API_KEY='${{ secrets.STRAPI_API_KEY }}'
            export AUTH_URL=${{ vars.AUTH_URL }}
            
            # Pull image with explicit env vars for the registry path
            sudo GCP_REGISTRY=\$GCP_REGISTRY PROJECT_ID=\$PROJECT_ID REPO_NAME=\$REPO_NAME IMAGE_NAME=\$IMAGE_NAME docker pull \$GCP_REGISTRY/\$PROJECT_ID/\$REPO_NAME/\$IMAGE_NAME:latest
            
            # Run docker compose with explicit env vars
            sudo GCP_REGISTRY=\$GCP_REGISTRY REPO_NAME=\$REPO_NAME IMAGE_NAME=\$IMAGE_NAME PROJECT_ID=\$PROJECT_ID STRAPI_URL=\$STRAPI_URL AUTH_SECRET=\$AUTH_SECRET STRAPI_API_KEY=\$STRAPI_API_KEY AUTH_URL=\$AUTH_URL \
              docker compose -f ~/docker-compose.yml up -d --force-recreate legacy-insights-next
          "
